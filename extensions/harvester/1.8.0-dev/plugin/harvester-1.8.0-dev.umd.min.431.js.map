{"version":3,"file":"harvester-1.8.0-dev.umd.min.431.js","mappings":"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","sources":["webpack://harvester-1.8.0-dev/./mixins/harvester-vm/impl.js","webpack://harvester-1.8.0-dev/./mixins/harvester-vm/index.js"],"sourcesContent":["import YAML from 'yaml';\nimport jsyaml from 'js-yaml';\nimport isEqual from 'lodash/isEqual';\nimport { clone } from '@shell/utils/object';\nimport { SECRET } from '@shell/config/types';\nimport { HCI as HCI_ANNOTATIONS } from '@pkg/harvester/config/labels-annotations';\nimport { HCI } from '../../types';\nimport { parseVolumeClaimTemplates } from '../../utils/vm';\nimport { OS } from './index';\n\nexport const QGA_JSON = {\n  package_update: true,\n  packages:       ['qemu-guest-agent'],\n  runcmd:         [\n    [\n      'systemctl',\n      'enable',\n      '--now',\n      'qemu-guest-agent.service'\n    ]\n  ]\n};\n\nexport const QGA_MAP = { default: 'qemu-guest-agent.service' };\n\nexport const USB_TABLET = [{\n  bus:  'usb',\n  name: 'tablet',\n  type: 'tablet'\n}];\n\nexport const SSH_EXISTING_TYPE = {\n  EXISTING_ALL:             'EXISTING_ALL',\n  EXISTING_ONLY_ANNOTATION: 'EXISTING_ANNOTATION',\n  EXISTING_ONLY_CLOUD:      'EXISTING_CLOUD',\n};\n\nexport default {\n  methods: {\n    hasCloudConfigComment(userScript) {\n      // Check that userData contains: #cloud-config\n      const userDataDoc = userScript ? YAML.parseDocument(userScript) : YAML.parseDocument({});\n      const items = userDataDoc?.contents?.items || [];\n\n      let exist = false;\n\n      if (userDataDoc?.comment === 'cloud-config' || userDataDoc?.comment?.includes('cloud-config\\n')) {\n        exist = true;\n      }\n\n      if (userDataDoc?.commentBefore === 'cloud-config' || userDataDoc?.commentBefore?.includes('cloud-config\\n')) {\n        exist = true;\n      }\n\n      items.map((item) => {\n        const key = item.key;\n\n        if (key?.commentBefore === 'cloud-config' || key?.commentBefore?.includes('cloud-config\\n')) {\n          exist = true;\n        }\n      });\n\n      return exist;\n    },\n\n    getSSHValue(id) {\n      const inStore = this.$store.getters['currentProduct'].inStore;\n      const sshs = this.$store.getters[`${ inStore }/all`](HCI.SSH) || [];\n\n      return sshs.find( (O) => O.id === id)?.spec?.publicKey || undefined;\n    },\n\n    getOsType(vm) {\n      return vm.metadata?.labels?.[HCI_ANNOTATIONS.OS];\n    },\n\n    getMatchQGA(osType) {\n      const _QGA_JSON = clone(QGA_JSON);\n      let hasCustomQGA = false;\n\n      OS.forEach((O) => {\n        if (O.match) {\n          hasCustomQGA = O.match.find((type) => type === osType);\n        }\n      });\n\n      if (hasCustomQGA) {\n        _QGA_JSON.runcmd[0][3] = QGA_MAP[osType];\n      } else {\n        _QGA_JSON.runcmd[0][3] = QGA_MAP['default'];\n      }\n\n      return _QGA_JSON;\n    },\n\n    getSimilarRuncmd(osType) {\n      const _QGA_JSON = clone(QGA_JSON);\n\n      if (osType === 'openSUSE') {\n        _QGA_JSON.runcmd[0][3] = QGA_MAP['default'];\n      } else {\n        _QGA_JSON.runcmd[0][3] = QGA_MAP['suse'];\n      }\n\n      return _QGA_JSON.runcmd[0];\n    },\n\n    hasInstallAgent(userScript, osType, oldValue) {\n      let dataFormat = {};\n      const _QGA_JSON = this.getMatchQGA(osType);\n\n      try {\n        dataFormat = jsyaml.load(userScript) || {};\n      } catch (e) {\n        new Error('Function(hasInstallAgent) error');\n\n        return oldValue;\n      }\n\n      return dataFormat?.packages?.includes('qemu-guest-agent') && !!dataFormat?.runcmd?.find( (S) => Array.isArray(S) && S.join('-') === _QGA_JSON.runcmd[0].join('-'));\n    },\n\n    isInstallUSBTablet(spec) {\n      const inputs = spec?.template?.spec?.domain?.devices?.inputs;\n\n      if (Array.isArray(inputs)) {\n        return !!inputs.find((O) => {\n          return isEqual(O, USB_TABLET[0]);\n        });\n      } else {\n        return false;\n      }\n    },\n\n    isEfiEnabled(spec) {\n      return !!(spec?.template?.spec?.domain?.firmware?.bootloader?.efi);\n    },\n\n    isTpmEnabled(spec) {\n      return !!spec?.template?.spec?.domain?.devices?.tpm;\n    },\n\n    isTPMPersistentStateEnabled(spec) {\n      return !!spec?.template?.spec?.domain?.devices?.tpm?.persistent;\n    },\n\n    isEFIPersistentStateEnabled(spec) {\n      return !!spec?.template?.spec?.domain?.firmware?.bootloader?.efi?.persistent;\n    },\n\n    isSecureBoot(spec) {\n      return !!spec?.template?.spec?.domain?.firmware?.bootloader?.efi?.secureBoot;\n    },\n\n    isCpuPinning(spec) {\n      return !!spec?.template?.spec?.domain?.cpu?.dedicatedCpuPlacement;\n    },\n\n    getCloudInitNoCloud(spec) {\n      const secret = this.getSecret(spec);\n      let userData = secret?.decodedData?.userdata;\n      let networkData = secret?.decodedData?.networkdata;\n\n      const cloudInitNoCloud = spec?.template?.spec?.volumes?.find( (V) => {\n        return V.name === 'cloudinitdisk';\n      })?.cloudInitNoCloud || {};\n\n      // If the value is not found inside the secret, the data may be written directly in the yaml\n      if (cloudInitNoCloud?.userData) {\n        userData = cloudInitNoCloud.userData;\n        this.saveUserDataAsClearText = true;\n      }\n\n      if (cloudInitNoCloud?.networkData) {\n        networkData = cloudInitNoCloud.networkData;\n        this.saveNetworkDataAsClearText = true;\n      }\n\n      return { userData, networkData };\n    },\n\n    getSecret(spec) {\n      const cloudInitNoCloud = spec?.template?.spec?.volumes?.find( (V) => {\n        return V.name === 'cloudinitdisk';\n      })?.cloudInitNoCloud || {};\n      const inStore = this.$store.getters['currentProduct'].inStore;\n      const secrets = this.$store.getters[`${ inStore }/all`](SECRET) || [];\n\n      const secretName = cloudInitNoCloud?.secretRef?.name || cloudInitNoCloud?.networkDataSecretRef?.name;\n\n      const secret = secrets.find((s) => s.metadata.name === secretName);\n\n      return secret;\n    },\n\n    getAccessCredentials(spec) {\n      const inStore = this.$store.getters['currentProduct'].inStore;\n      const secrets = this.$store.getters[`${ inStore }/all`](SECRET) || [];\n      const credentials = spec?.template?.spec?.accessCredentials || [];\n      const annotations = JSON.parse(spec.template.metadata?.annotations?.[HCI_ANNOTATIONS.DYNAMIC_SSHKEYS_NAMES] || '[]');\n\n      return credentials.map((c) => {\n        const source = !!c.userPassword ? 'userPassword' : 'sshPublicKey';\n        const secretName = c[source]?.source?.secret?.secretName;\n        const secretRef = secrets.find((s) => s.metadata.name === secretName);\n        const out = {\n          source, username: '', newPassword: '', users: [], sshkeys: [], secretName, secretRef\n        };\n\n        if (!secretRef) {\n          out.secretRef = undefined;\n        } else if (source === 'userPassword') {\n          const username = Object.keys(secretRef?.data)[0];\n          const newPassword = secretRef.decodedData[username];\n\n          out.username = username;\n          out.newPassword = newPassword;\n        } else {\n          const users = c[source].propagationMethod.qemuGuestAgent.users;\n          const sshkeys = annotations?.[secretName];\n\n          out.users = users;\n          out.sshkeys = sshkeys;\n        }\n\n        return out;\n      });\n    },\n\n    getRootImageId(vm) {\n      const volumes = parseVolumeClaimTemplates(vm);\n\n      return volumes?.[0]?.metadata?.annotations?.[HCI_ANNOTATIONS.IMAGE_ID] || '';\n    },\n\n    getSSHFromAnnotation(spec) {\n      const ids = spec?.template?.metadata?.annotations?.[HCI_ANNOTATIONS.SSH_NAMES] || '[]';\n\n      return JSON.parse(ids);\n    },\n\n    convertToJson(script = '') {\n      let out = {};\n\n      try {\n        out = jsyaml.load(script);\n      } catch (e) {\n        new Error('Function(convertToJson) error');\n      }\n\n      return out;\n    },\n\n    getSSHFromUserData(userData) {\n      return this.convertToJson(userData)?.ssh_authorized_keys || [];\n    },\n\n    compareSSHValue(a = '', b = '') {\n      const r = /(\\r\\n\\t|\\n|\\r\\t)|(\\s*)/gm;\n\n      return a.replace(r, '') === b.replace(r, '');\n    },\n\n    mergeAllSSHs(spec) {\n      const keys = this.getSSHFromAnnotation(spec);\n      const { userScript: userData } = this.getCloudInitNoCloud(spec);\n\n      if (!keys?.length < 0 && !userData) {\n        return [];\n      }\n\n      let out = [];\n\n      const inStore = this.$store.getters['currentProduct'].inStore;\n      const allSSHs = this.$store.getters[`${ inStore }/all`](HCI.SSH) || [];\n\n      out = (keys || []).map((id) => {\n        const hasSSHResource = allSSHs.find((ssh) => ssh.id === id);\n\n        if (hasSSHResource) {\n          return {\n            id:   hasSSHResource.id,\n            data: hasSSHResource,\n            type: SSH_EXISTING_TYPE.EXISTING_ALL\n          };\n        } else {\n          return {\n            id,\n            data: id,\n            type: SSH_EXISTING_TYPE.EXISTING_ONLY_ANNOTATION\n          };\n        }\n      });\n\n      const _userDataSSH = this.getSSHFromUserData(userData);\n\n      _userDataSSH.map( (sshValue) => {\n        const hasSSHResource = allSSHs.find((ssh) => this.compareSSHValue(sshValue, ssh.spec?.publicKey));\n\n        if (hasSSHResource && !out.find((O) => O.id === hasSSHResource.id)) {\n          out.push({\n            id:   hasSSHResource.id,\n            data: hasSSHResource,\n            type: SSH_EXISTING_TYPE.EXISTING_ALL\n          });\n        } else if (!hasSSHResource) {\n          out.push({\n            id:   'Unknown',\n            data: sshValue,\n            type: SSH_EXISTING_TYPE.EXISTING_ONLY_CLOUD\n          });\n        }\n      });\n\n      return out;\n    },\n  },\n};\n","import YAML from 'yaml';\nimport jsyaml from 'js-yaml';\nimport isEqual from 'lodash/isEqual';\nimport isEmpty from 'lodash/isEmpty';\nimport difference from 'lodash/difference';\nimport { sortBy } from '@shell/utils/sort';\nimport { set } from '@shell/utils/object';\nimport { getVmCPUMemoryValues } from '../../utils/cpuMemory';\nimport { allHash } from '@shell/utils/promise';\nimport { randomStr } from '@shell/utils/string';\nimport { base64Decode } from '@shell/utils/crypto';\nimport { formatSi, parseSi } from '@shell/utils/units';\nimport { _CLONE, _CREATE, _VIEW } from '@shell/config/query-params';\nimport {\n  PV, PVC, STORAGE_CLASS, NODE, SECRET, CONFIG_MAP, NETWORK_ATTACHMENT, NAMESPACE, LONGHORN\n} from '@shell/config/types';\nimport { HOSTNAME } from '@shell/config/labels-annotations';\nimport { HCI as HCI_ANNOTATIONS } from '@pkg/harvester/config/labels-annotations';\nimport { uniq } from '@shell/utils/array';\nimport {\n  ADD_ONS, SOURCE_TYPE, ACCESS_CREDENTIALS, maintenanceStrategies, runStrategies\n} from '../../config/harvester-map';\nimport { HCI_SETTING } from '../../config/settings';\nimport { HCI } from '../../types';\nimport { parseVolumeClaimTemplates, EMPTY_IMAGE } from '../../utils/vm';\nimport impl, { QGA_JSON, USB_TABLET } from './impl';\nimport { GIBIBYTE } from '../../utils/unit';\nimport { VOLUME_MODE } from '@pkg/harvester/config/types';\n\nconst LONGHORN_V2_DATA_ENGINE = 'longhorn-system/v2-data-engine';\n\nexport const MANAGEMENT_NETWORK = 'management Network';\n\nexport const OS = [{\n  label: 'Windows',\n  value: 'windows'\n}, {\n  label: 'Linux',\n  value: 'linux'\n}, {\n  label: 'SUSE Linux Enterprise',\n  value: 'SLEs'\n}, {\n  label: 'Debian',\n  value: 'debian'\n}, {\n  label: 'Fedora',\n  value: 'fedora'\n}, {\n  label: 'Gentoo',\n  value: 'gentoo'\n}, {\n  label: 'Oracle',\n  value: 'oracle'\n}, {\n  label: 'Red Hat',\n  match: ['redhat', 'rhel'],\n  value: 'redhat'\n}, {\n  label: 'openSUSE',\n  value: 'openSUSE',\n}, {\n  label: 'Ubuntu',\n  value: 'ubuntu'\n}, {\n  label: 'Other Linux',\n  match: ['centos'],\n  value: 'otherLinux'\n}];\n\nexport const CD_ROM = 'cd-rom';\nexport const HARD_DISK = 'disk';\n\nexport default {\n  mixins: [impl],\n\n  props: {\n    value: {\n      type:     Object,\n      required: true,\n    },\n\n    resourceType: {\n      type:    String,\n      default: ''\n    }\n  },\n\n  async fetch() {\n    const inStore = this.$store.getters['currentProduct'].inStore;\n    const hash = {\n      pvs:               this.$store.dispatch(`${ inStore }/findAll`, { type: PV }),\n      pvcs:              this.$store.dispatch(`${ inStore }/findAll`, { type: PVC }),\n      storageClasses:    this.$store.dispatch(`${ inStore }/findAll`, { type: STORAGE_CLASS }),\n      sshs:              this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.SSH }),\n      settings:          this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.SETTING }),\n      images:            this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.IMAGE }),\n      versions:          this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.VM_VERSION }),\n      templates:         this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.VM_TEMPLATE }),\n      networkAttachment: this.$store.dispatch(`${ inStore }/findAll`, { type: NETWORK_ATTACHMENT }),\n      vmis:              this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.VMI }),\n      vmims:             this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.VMIM }),\n      vms:               this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.VM }),\n      secrets:           this.$store.dispatch(`${ inStore }/findAll`, { type: SECRET }),\n      addons:            this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.ADD_ONS }),\n      longhornV2Engine:  this.$store.dispatch(`${ inStore }/find`, { type: LONGHORN.SETTINGS, id: LONGHORN_V2_DATA_ENGINE }),\n    };\n\n    if (this.$store.getters[`${ inStore }/schemaFor`](NODE)) {\n      hash.nodes = this.$store.dispatch(`${ inStore }/findAll`, { type: NODE });\n    }\n\n    if (this.$store.getters[`${ inStore }/schemaFor`](HCI.CLUSTER_NETWORK)) {\n      hash.clusterNetworks = this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.CLUSTER_NETWORK });\n    }\n\n    if (this.$store.getters[`${ inStore }/schemaFor`](HCI.VLAN_CONFIG)) {\n      hash.clusterNetworks = this.$store.dispatch(`${ inStore }/findAll`, { type: HCI.VLAN_CONFIG });\n    }\n\n    if (this.$store.getters[`${ inStore }/schemaFor`](LONGHORN.VOLUMES)) {\n      hash.longhornVolumes = this.$store.dispatch(`${ inStore }/findAll`, { type: LONGHORN.VOLUMES });\n    }\n\n    const res = await allHash(hash);\n\n    const hasPCISchema = !!this.$store.getters[`${ inStore }/schemaFor`](HCI.PCI_DEVICE);\n    const hasSRIOVGPUSchema = !!this.$store.getters[`${ inStore }/schemaFor`](HCI.SR_IOVGPU_DEVICE);\n\n    const enabledAddons = res.addons.reduce((acc, addon) => ({ ...acc, [addon.name]: addon.spec?.enabled }), {});\n\n    this.enabledPCI = hasPCISchema && enabledAddons[ADD_ONS.PCI_DEVICE_CONTROLLER];\n    this.enabledSriovgpu = hasSRIOVGPUSchema && enabledAddons[ADD_ONS.PCI_DEVICE_CONTROLLER] && enabledAddons[ADD_ONS.NVIDIA_DRIVER_TOOLKIT_CONTROLLER];\n  },\n\n  data() {\n    const isClone = this.realMode === _CLONE;\n\n    return {\n      OS,\n      isClone,\n      showYaml:                      false,\n      spec:                          null,\n      osType:                        'linux',\n      useTemplate:                   false,\n      sshKey:                        [],\n      maintenanceStrategies,\n      maintenanceStrategy:           'Migrate',\n      runStrategies,\n      runStrategy:                   'RerunOnFailure',\n      installAgent:                  true,\n      hasCreateVolumes:              [],\n      installUSBTablet:              true,\n      networkScript:                 '',\n      userScript:                    '',\n      imageId:                       '',\n      diskRows:                      [],\n      networkRows:                   [],\n      machineType:                   '',\n      machineTypes:                  [],\n      secretName:                    '',\n      secretRef:                     null,\n      showAdvanced:                  false,\n      deleteAgent:                   true,\n      memory:                        null,\n      cpu:                           '',\n      maxMemory:                     null,\n      maxCpu:                        '',\n      cpuMemoryHotplugEnabled:       false,\n      reservedMemory:                null,\n      accessCredentials:             [],\n      efiEnabled:                    false,\n      tpmEnabled:                    false,\n      tpmPersistentStateEnabled:     false,\n      efiPersistentStateEnabled:     false,\n      secureBoot:                    false,\n      userDataTemplateId:            '',\n      saveUserDataAsClearText:       false,\n      saveNetworkDataAsClearText:    false,\n      enabledPCI:                    false,\n      enabledSriovgpu:               false,\n      immutableMode:                 this.realMode === _CREATE ? _CREATE : _VIEW,\n      terminationGracePeriodSeconds: '',\n      cpuPinning:                    false,\n      cpuModel:                      '',\n    };\n  },\n\n  computed: {\n    inStore() {\n      return this.$store.getters['currentProduct'].inStore;\n    },\n\n    images() {\n      return this.$store.getters[`${ this.inStore }/all`](HCI.IMAGE);\n    },\n\n    versions() {\n      return this.$store.getters[`${ this.inStore }/all`](HCI.VM_VERSION);\n    },\n\n    templates() {\n      return this.$store.getters[`${ this.inStore }/all`](HCI.VM_TEMPLATE);\n    },\n\n    pvcs() {\n      return this.$store.getters[`${ this.inStore }/all`](PVC);\n    },\n\n    secrets() {\n      return this.$store.getters[`${ this.inStore }/all`](SECRET);\n    },\n\n    filteredNamespaces() {\n      return this.$store.getters['harvester/all'](NAMESPACE).filter((namespace) => !namespace.isSystem);\n    },\n\n    nodes() {\n      return this.$store.getters['harvester/all'](NODE);\n    },\n\n    nodesIdOptions() {\n      const nodes = this.$store.getters[`${ this.inStore }/all`](NODE);\n\n      const networkNames = this.networkRows.map((n) => n.networkName);\n      const vmNetworks = this.$store.getters[`${ this.inStore }/all`](NETWORK_ATTACHMENT);\n      const selectedVMNetworks = networkNames.map((name) => vmNetworks.find((n) => n.id === name)).filter((n) => n?.id);\n      const clusterNetworks = uniq(selectedVMNetworks.map((n) => n.clusterNetworkResource?.id));\n\n      return nodes.filter((N) => !N.isUnSchedulable && N.isEtcd !== 'true').map((node) => {\n        const requireLabelKeys = [];\n        let isNetworkSchedule = true;\n\n        if (clusterNetworks.length > 0) {\n          clusterNetworks.map((clusterNetwork) => {\n            requireLabelKeys.push(`network.harvesterhci.io/${ clusterNetwork }`);\n          });\n        }\n\n        requireLabelKeys.map((requireLabelKey) => {\n          if (node.metadata?.labels?.[requireLabelKey] !== 'true') {\n            isNetworkSchedule = false;\n          }\n        });\n\n        return {\n          label:    isNetworkSchedule ? node.nameDisplay : `${ node.nameDisplay } (${ this.t('harvester.virtualMachine.scheduling.networkNotSupport') })`,\n          value:    node.id,\n          disabled: !isNetworkSchedule,\n        };\n      });\n    },\n\n    storageClassSetting() {\n      try {\n        const storageClassValue = this.$store.getters[`${ this.inStore }/all`](HCI.SETTING).find( (O) => O.id === HCI_SETTING.DEFAULT_STORAGE_CLASS)?.value;\n\n        return JSON.parse(storageClassValue);\n      } catch (e) {\n        return {};\n      }\n    },\n\n    customVolumeMode() {\n      return this.storageClassSetting.volumeMode || VOLUME_MODE.BLOCK;\n    },\n\n    customAccessMode() {\n      return this.storageClassSetting.accessModes || 'ReadWriteMany';\n    },\n\n    isWindows() {\n      return this.osType === 'windows';\n    },\n\n    needNewSecret() {\n      // When creating a template it is always necessary to create a new secret.\n      return this.isCreate || this.showYaml ? false : this.resourceType === HCI.VM_VERSION;\n    },\n\n    defaultTerminationSetting() {\n      const setting = this.$store.getters[`${ this.inStore }/all`](HCI.SETTING).find( (O) => O.id === HCI_SETTING.VM_TERMINATION_PERIOD) || {};\n\n      return Number(setting?.value || setting?.default);\n    },\n\n    affinityLabels() {\n      return {\n        namespaceInputLabel:      this.t('harvester.virtualMachine.affinity.namespaces.label'),\n        namespaceSelectionLabels: [\n          this.t('harvester.virtualMachine.affinity.thisPodNamespace'),\n          this.t('workload.scheduling.affinity.allNamespaces'),\n          this.t('harvester.virtualMachine.affinity.matchExpressions.inNamespaces')\n        ],\n        addLabel:               this.t('harvester.virtualMachine.affinity.addLabel'),\n        topologyKeyPlaceholder: this.t('harvester.virtualMachine.affinity.topologyKey.placeholder')\n      };\n    },\n  },\n\n  async created() {\n    await this.$store.dispatch(`${ this.inStore }/findAll`, { type: SECRET });\n\n    if (!this.value.vmMachineTypeAutoFeatureEnabled) {\n      try {\n        const url = this.$store.getters['harvester-common/getHarvesterClusterUrl'](\n          'v1/harvester/clusters/local?link=machineTypes'\n        );\n        const machineTypes = await this.$store.dispatch('harvester/request', { url });\n\n        this.machineTypes = machineTypes;\n      } catch (err) {\n        this.machineTypes = [''];\n      }\n    } else {\n      this.machineTypes = [''];\n    }\n\n    this.getInitConfig({ value: this.value, init: this.isCreate });\n  },\n\n  methods: {\n    getInitConfig(config) {\n      const {\n        value, existUserData, fromTemplate = false, init = false\n      } = config;\n\n      const vm = this.resourceType === HCI.VM ? value : this.resourceType === HCI.BACKUP ? this.value.status?.source : value.spec.vm;\n      const volumeBackups = this.resourceType === HCI.BACKUP ? this.value.status?.volumeBackups : null;\n\n      const spec = vm?.spec;\n\n      if (!spec) {\n        return;\n      }\n      const resources = spec.template.spec.domain.resources;\n\n      // If the user is created via yaml, there may be no \"resources.limits\": kubectl apply -f https://kubevirt.io/labs/manifests/vm.yaml\n      if (!resources?.limits || (resources?.limits && !resources?.limits?.memory && resources?.limits?.memory !== null)) {\n        spec.template.spec.domain.resources = {\n          ...spec.template.spec.domain.resources,\n          limits: {\n            ...spec.template.spec.domain.resources.limits,\n            memory: spec.template.spec.domain.resources.requests.memory\n          }\n        };\n      }\n\n      if (!vm.metadata.labels) {\n        vm.metadata.labels = {};\n      }\n      const maintenanceStrategy = vm.metadata.labels?.[HCI_ANNOTATIONS.VM_MAINTENANCE_MODE_STRATEGY] || 'Migrate';\n\n      const runStrategy = spec.runStrategy || 'RerunOnFailure';\n      const machineType = spec.template.spec.domain?.machine?.type || this.machineTypes[0];\n\n      const {\n        cpu, memory, maxCpu, maxMemory, isHotplugEnabled\n      } = getVmCPUMemoryValues(vm);\n      const cpuMemoryHotplugEnabled = isHotplugEnabled;\n\n      const reservedMemory = vm.metadata?.annotations?.[HCI_ANNOTATIONS.VM_RESERVED_MEMORY];\n      const terminationGracePeriodSeconds = spec.template.spec?.terminationGracePeriodSeconds || this.defaultTerminationSetting;\n\n      const sshKey = this.getSSHFromAnnotation(spec) || [];\n\n      const imageId = this.getRootImageId(vm) || '';\n      const diskRows = this.getDiskRows(vm, volumeBackups);\n\n      const networkRows = this.getNetworkRows(vm, { fromTemplate, init });\n      const hasCreateVolumes = this.getHasCreatedVolumes(spec) || [];\n\n      let { userData = undefined, networkData = undefined } = this.getCloudInitNoCloud(spec);\n\n      if (this.resourceType === HCI.BACKUP) {\n        const secretBackups = this.value.status?.secretBackups;\n\n        if (secretBackups) {\n          const secretNetworkData = secretBackups[0]?.data?.networkdata || '';\n          const secretUserData = secretBackups[0]?.data?.userdata || '';\n\n          userData = base64Decode(secretUserData);\n          networkData = base64Decode(secretNetworkData);\n        }\n      }\n      const osType = this.getOsType(vm) || 'linux';\n\n      userData = this.isCreate && !existUserData && !this.isClone ? this.getInitUserData({ osType }) : userData;\n\n      const installUSBTablet = this.isInstallUSBTablet(spec);\n      const installAgent = this.hasInstallAgent(userData, osType, true);\n      const efiEnabled = this.isEfiEnabled(spec);\n      const tpmEnabled = this.isTpmEnabled(spec);\n      const tpmPersistentStateEnabled = this.isTPMPersistentStateEnabled(spec);\n      const efiPersistentStateEnabled = this.isEFIPersistentStateEnabled(spec);\n      const secureBoot = this.isSecureBoot(spec);\n      const cpuPinning = this.isCpuPinning(spec);\n      const cpuModel = spec.template.spec.domain.cpu?.model || '';\n\n      const secretRef = this.getSecret(spec);\n      const accessCredentials = this.getAccessCredentials(spec);\n\n      if (Object.prototype.hasOwnProperty.call(spec, 'running')) {\n        delete spec.running;\n        spec.runStrategy = 'RerunOnFailure';\n      }\n\n      this['spec'] = spec;\n      this['maintenanceStrategy'] = maintenanceStrategy;\n      this['runStrategy'] = runStrategy;\n      this['secretRef'] = secretRef;\n      this['accessCredentials'] = accessCredentials;\n      this['userScript'] = userData;\n      this['networkScript'] = networkData;\n\n      this['sshKey'] = sshKey;\n      this['osType'] = osType;\n      this['installAgent'] = installAgent;\n\n      this['cpu'] = cpu;\n      this['memory'] = memory;\n      this['maxCpu'] = maxCpu;\n      this['maxMemory'] = maxMemory;\n      this['cpuMemoryHotplugEnabled'] = cpuMemoryHotplugEnabled;\n      this['reservedMemory'] = reservedMemory;\n      this['machineType'] = machineType;\n      this['terminationGracePeriodSeconds'] = terminationGracePeriodSeconds;\n\n      this['installUSBTablet'] = installUSBTablet;\n      this['efiEnabled'] = efiEnabled;\n      this['efiPersistentStateEnabled'] = efiPersistentStateEnabled;\n      this['tpmEnabled'] = tpmEnabled;\n      this['tpmPersistentStateEnabled'] = tpmPersistentStateEnabled;\n      this['secureBoot'] = secureBoot;\n      this['cpuPinning'] = cpuPinning;\n      this['cpuModel'] = cpuModel;\n\n      this['hasCreateVolumes'] = hasCreateVolumes;\n      this['networkRows'] = networkRows;\n      this['imageId'] = imageId;\n\n      this['diskRows'] = diskRows;\n\n      this.refreshYamlEditor();\n    },\n\n    getDiskRows(vm, volBackups) {\n      const namespace = vm.metadata.namespace;\n      const _volumes = vm.spec.template.spec.volumes || [];\n      const _disks = vm.spec.template.spec.domain.devices.disks || [];\n      const _volumeClaimTemplates = parseVolumeClaimTemplates(vm);\n\n      let out = [];\n\n      if (_disks.length === 0) {\n        let bus = 'virtio';\n        let type = HARD_DISK;\n        let size = '10Gi';\n\n        const imageResource = this.images.find( (I) => this.imageId === I.id);\n\n        const isIsoImage = /iso$/i.test(imageResource?.imageSuffix);\n        const imageSize = Math.max(imageResource?.status?.size, imageResource?.status?.virtualSize);\n        const isEncrypted = imageResource?.isEncrypted || false;\n        const volumeBackups = volBackups?.find((vBackup) => vBackup.volumeName === 'disk-0') || null ;\n\n        if (isIsoImage) {\n          bus = 'sata';\n          type = CD_ROM;\n        }\n\n        if (imageSize) {\n          let imageSizeGiB = Math.ceil(imageSize / 1024 / 1024 / 1024);\n\n          if (!isIsoImage) {\n            imageSizeGiB = Math.max(imageSizeGiB, 10);\n          }\n          size = `${ imageSizeGiB }${ GIBIBYTE }`;\n        }\n\n        out.push({\n          id:               randomStr(5),\n          source:           SOURCE_TYPE.IMAGE,\n          name:             'disk-0',\n          accessMode:       'ReadWriteMany', // root disk only support LHv1 volume, should be RWX\n          bus,\n          volumeName:       '',\n          size,\n          type,\n          storageClassName: '',\n          image:            this.imageId,\n          volumeMode:       VOLUME_MODE.BLOCK,\n          isEncrypted,\n          volumeBackups,\n        });\n      } else {\n        out = _disks.map( (DISK, index) => {\n          const volume = _volumes.find( (V) => V.name === DISK.name );\n\n          let size = '';\n          let image = '';\n          let source = '';\n          let realName = '';\n          let container = '';\n          let volumeName = '';\n          let accessMode = '';\n          let volumeMode = '';\n          let storageClassName = '';\n          let hotpluggable = false;\n          let dataSource = null;\n\n          const type = DISK?.cdrom ? CD_ROM : DISK?.disk ? HARD_DISK : '';\n\n          if (type === CD_ROM && volume === undefined) {\n            // Empty CD_ROM\n            source = SOURCE_TYPE.IMAGE;\n            image = EMPTY_IMAGE;\n            size = `0${ GIBIBYTE }`;\n          } else if (volume.containerDisk) { // SOURCE_TYPE.CONTAINER\n            source = SOURCE_TYPE.CONTAINER;\n            container = volume.containerDisk.image;\n          } else if (volume.persistentVolumeClaim && volume.persistentVolumeClaim?.claimName) {\n            volumeName = volume.persistentVolumeClaim.claimName;\n            const DVT = _volumeClaimTemplates.find( (T) => T.metadata.name === volumeName);\n\n            realName = volumeName;\n            // If the DVT can be found, it cannot be an existing volume\n            if (DVT) {\n              // has annotation (HCI_ANNOTATIONS.IMAGE_ID) => SOURCE_TYPE.IMAGE\n              if (DVT.metadata?.annotations?.[HCI_ANNOTATIONS.IMAGE_ID] !== undefined) {\n                image = DVT.metadata?.annotations?.[HCI_ANNOTATIONS.IMAGE_ID];\n                source = SOURCE_TYPE.IMAGE;\n              } else {\n                source = SOURCE_TYPE.NEW;\n              }\n\n              const dataVolumeSpecPVC = DVT?.spec || {};\n\n              volumeMode = dataVolumeSpecPVC?.volumeMode;\n              accessMode = dataVolumeSpecPVC?.accessModes?.[0];\n              size = dataVolumeSpecPVC?.resources?.requests?.storage || '10Gi';\n              storageClassName = dataVolumeSpecPVC?.storageClassName;\n              dataSource = dataVolumeSpecPVC?.dataSource;\n            } else {\n              // SOURCE_TYPE.ATTACH_VOLUME\n              // Compatible with VMS that have been created before, Because they're not saved in the annotation\n              const allPVCs = this.$store.getters['harvester/all'](PVC);\n              const pvcResource = allPVCs.find( (O) => O.id === `${ namespace }/${ volume?.persistentVolumeClaim?.claimName }`);\n\n              source = SOURCE_TYPE.ATTACH_VOLUME;\n              accessMode = pvcResource?.spec?.accessModes?.[0] || 'ReadWriteMany';\n              size = pvcResource?.spec?.resources?.requests?.storage || '10Gi';\n              storageClassName = pvcResource?.spec?.storageClassName;\n              volumeMode = pvcResource?.spec?.volumeMode || VOLUME_MODE.BLOCK;\n              volumeName = pvcResource?.metadata?.name || '';\n            }\n\n            hotpluggable = volume.persistentVolumeClaim.hotpluggable || false;\n          }\n\n          const bus = DISK?.disk?.bus || DISK?.cdrom?.bus;\n\n          const bootOrder = DISK?.bootOrder ? DISK?.bootOrder : index;\n\n          const parseValue = parseSi(size);\n\n          const formatSize = formatSi(parseValue, {\n            increment:   1024,\n            addSuffix:   false,\n            maxExponent: 3,\n            minExponent: 3,\n          });\n\n          const pvc = this.pvcs.find((P) => P.id === `${ this.value.metadata.namespace }/${ volumeName }`);\n\n          const volumeStatus = pvc?.relatedPV?.metadata?.annotations?.[HCI_ANNOTATIONS.VOLUME_ERROR];\n\n          const isEncrypted = pvc?.isEncrypted || false;\n          const volumeBackups = volBackups?.find((vBackup) => vBackup.volumeName === DISK.name) || null;\n\n          return {\n            id:         randomStr(5),\n            bootOrder,\n            source,\n            name:       DISK.name,\n            realName,\n            bus,\n            volumeName,\n            container,\n            accessMode,\n            size:       `${ formatSize }${ GIBIBYTE }`,\n            volumeMode: volumeMode || this.customVolumeMode,\n            image,\n            type,\n            storageClassName,\n            hotpluggable,\n            volumeStatus,\n            dataSource,\n            namespace,\n            isEncrypted,\n            volumeBackups,\n          };\n        });\n      }\n\n      out = sortBy(out, 'bootOrder');\n\n      return out.filter( (O) => O.name !== 'cloudinitdisk');\n    },\n\n    getNetworkRows(vm, config) {\n      const { fromTemplate = false, init = false } = config;\n\n      const networks = vm.spec.template.spec.networks || [];\n      const interfaces = vm.spec.template.spec.domain.devices.interfaces || [];\n\n      const out = interfaces.map( (I, index) => {\n        const network = networks.find( (N) => I.name === N.name);\n\n        const type = I.sriov ? 'sriov' : I.bridge ? 'bridge' : 'masquerade';\n\n        const isPod = !!network.pod;\n\n        return {\n          ...I,\n          index,\n          type,\n          isPod,\n          newCreateId: (fromTemplate || init) ? randomStr(10) : false,\n          model:       I.model,\n          networkName: isPod ? MANAGEMENT_NETWORK : network?.multus?.networkName,\n        };\n      });\n\n      return out;\n    },\n\n    parseVM() {\n      this.userData = this.getUserData({ osType: this.osType, installAgent: this.installAgent });\n      this.parseOther();\n      this.parseAccessCredentials();\n      this.parseNetworkRows(this.networkRows);\n      this.parseDiskRows(this.diskRows);\n    },\n\n    parseOther() {\n      if (!this.spec.template.spec.domain.machine) {\n        this.spec.template.spec.domain['machine'] = { type: this.machineType };\n      } else {\n        this.spec.template.spec.domain.machine['type'] = this.machineType;\n      }\n\n      this.setCPUAndMemory();\n      // update terminationGracePeriodSeconds\n      this.spec.template.spec.terminationGracePeriodSeconds = this.terminationGracePeriodSeconds;\n\n      const vm = this.resourceType === HCI.VM ? this.value : this.value.spec.vm;\n\n      // parse reserved memory\n      if (!this.reservedMemory) {\n        delete vm.metadata.annotations[HCI_ANNOTATIONS.VM_RESERVED_MEMORY];\n      } else {\n        vm.metadata.annotations[HCI_ANNOTATIONS.VM_RESERVED_MEMORY] = this.reservedMemory;\n      }\n\n      // add or remove cpu memory hotplug annotation\n      if (this.cpuMemoryHotplugEnabled) {\n        vm.metadata.annotations[HCI_ANNOTATIONS.VM_CPU_MEMORY_HOTPLUG] = this.cpuMemoryHotplugEnabled.toString();\n      } else {\n        delete vm.metadata.annotations[HCI_ANNOTATIONS.VM_CPU_MEMORY_HOTPLUG];\n      }\n\n      if (this.maintenanceStrategy === 'Migrate') {\n        delete vm.metadata.labels[HCI_ANNOTATIONS.VM_MAINTENANCE_MODE_STRATEGY];\n      } else {\n        vm.metadata.labels[HCI_ANNOTATIONS.VM_MAINTENANCE_MODE_STRATEGY] = this.maintenanceStrategy;\n      }\n    },\n\n    setCPUAndMemory() {\n      if (this.cpuMemoryHotplugEnabled) {\n        // set CPU\n        this.spec.template.spec.domain.cpu.sockets = this.cpu;\n        this.spec.template.spec.domain.cpu.cores = 1;\n\n        // set max CPU\n        set(this.spec.template.spec, 'domain.cpu.maxSockets', this.maxCpu);\n        // domain.resources.limits.cpu and memory are defined by k8s which requires string values\n        // see https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/\n        set(this.spec.template.spec, 'domain.resources.limits.cpu', this.maxCpu?.toString());\n\n        // set memory\n        set(this.spec.template.spec, 'domain.memory.guest', this.memory);\n\n        // set max memory\n        set(this.spec.template.spec, 'domain.memory.maxGuest', this.maxMemory);\n        set(this.spec.template.spec, 'domain.resources.limits.memory', this.maxMemory);\n      } else {\n        this.spec.template.spec.domain.cpu.sockets = 1;\n        this.spec.template.spec.domain.cpu.cores = this.cpu;\n        this.spec.template.spec.domain.resources.limits.cpu = this.cpu?.toString();\n        this.spec.template.spec.domain.resources.limits.memory = this.memory;\n        // clean below fields as we don't need them if not enable CPU and memory hotplug\n        if (this.spec?.template?.spec?.domain?.memory?.maxGuest) {\n          delete this.spec.template.spec.domain.memory.maxGuest;\n        }\n      }\n    },\n\n    needVolume(R) {\n      if (R.image === EMPTY_IMAGE) {\n        return false;\n      }\n\n      return true;\n    },\n\n    parseDiskRows(disk) {\n      const disks = [];\n      const volumes = [];\n      const diskNameLabels = [];\n      const volumeClaimTemplates = [];\n\n      disk.forEach( (R, index) => {\n        const _disk = this.parseDisk(R, index);\n\n        disks.push(_disk);\n\n        if (this.needVolume(R)) {\n          const prefixName = this.value.metadata?.name || '';\n          const dataVolumeName = this.parseDataVolumeName(R, prefixName);\n          const _volume = this.parseVolume(R, dataVolumeName);\n          const _dataVolumeTemplate = this.parseVolumeClaimTemplate(R, dataVolumeName);\n\n          volumes.push(_volume);\n          diskNameLabels.push(dataVolumeName);\n          volumeClaimTemplates.push(_dataVolumeTemplate);\n        }\n      });\n\n      if (this.needNewSecret || !this.secretName) {\n        this.secretName = this.generateSecretName(this.secretNamePrefix);\n      }\n\n      if (!disks.find( (D) => D.name === 'cloudinitdisk') && (this.userData || this.networkData)) {\n        if (!this.isWindows) {\n          disks.push({\n            name: 'cloudinitdisk',\n            disk: { bus: 'virtio' }\n          });\n\n          const userData = this.getUserData({ osType: this.osType, installAgent: this.installAgent });\n\n          const cloudinitdisk = {\n            name:             'cloudinitdisk',\n            cloudInitNoCloud: {}\n          };\n\n          if (this.saveUserDataAsClearText) {\n            cloudinitdisk.cloudInitNoCloud.userData = userData;\n          } else {\n            cloudinitdisk.cloudInitNoCloud.secretRef = { name: this.secretName };\n          }\n\n          if (this.saveNetworkDataAsClearText) {\n            cloudinitdisk.cloudInitNoCloud.networkData = this.networkScript;\n          } else {\n            cloudinitdisk.cloudInitNoCloud.networkDataSecretRef = { name: this.secretName };\n          }\n\n          volumes.push(cloudinitdisk);\n        }\n      }\n\n      const specDisks = this.spec?.template?.spec?.domain?.devices?.disks;\n      const mergedDisks = this.mergeDeviceList(specDisks, disks);\n\n      let spec = {\n        ...this.spec,\n        runStrategy: this.runStrategy,\n        template:    {\n          ...this.spec.template,\n          metadata: {\n            ...this.spec?.template?.metadata,\n            annotations: {\n              ...this.spec?.template?.metadata?.annotations,\n              [HCI_ANNOTATIONS.SSH_NAMES]: JSON.stringify(this.sshKey)\n            },\n            labels: {\n              ...this.spec?.template?.metadata?.labels,\n              [HCI_ANNOTATIONS.VM_NAME]: this.value?.metadata?.name,\n            }\n          },\n          spec: {\n            ...this.spec.template?.spec,\n            domain: {\n              ...this.spec.template?.spec?.domain,\n              devices: {\n                ...this.spec.template?.spec?.domain?.devices,\n                disks: mergedDisks,\n              },\n            },\n            volumes,\n          }\n        }\n      };\n\n      if (volumes.length === 0) {\n        delete spec.template.spec.volumes;\n      }\n\n      if (this.resourceType === HCI.VM) {\n        if (!this.isSingle) {\n          spec = this.multiVMScheduler(spec);\n        }\n\n        this.value.metadata['annotations'] = {\n          ...this.value.metadata.annotations,\n          [HCI_ANNOTATIONS.VOLUME_CLAIM_TEMPLATE]: JSON.stringify(volumeClaimTemplates),\n          [HCI_ANNOTATIONS.NETWORK_IPS]:           JSON.stringify(this.value.networkIps)\n        };\n\n        this.value.metadata['labels'] = {\n          ...this.value.metadata.labels,\n          [HCI_ANNOTATIONS.CREATOR]: 'harvester',\n          [HCI_ANNOTATIONS.OS]:      this.osType\n        };\n\n        this.value['spec'] = spec;\n        this['spec'] = spec;\n      } else if (this.resourceType === HCI.VM_VERSION) {\n        this.value.spec.vm['spec'] = spec;\n        this.value.spec.vm.metadata['annotations'] = {\n          ...this.value.spec.vm.metadata.annotations,\n          [HCI_ANNOTATIONS.VOLUME_CLAIM_TEMPLATE]: JSON.stringify(volumeClaimTemplates),\n        };\n        this.value.spec.vm.metadata['labels'] = {\n          ...this.value.spec.vm.metadata.labels,\n          [HCI_ANNOTATIONS.OS]: this.osType\n        };\n        this['spec'] = spec;\n      }\n    },\n\n    removeTrailingHyphen(str) {\n      while (str.endsWith('-')) {\n        str = str.slice(0, -1);\n      }\n\n      return str;\n    },\n\n    multiVMScheduler(spec) {\n      const namePrefix = this.removeTrailingHyphen(this.namePrefix);\n\n      spec.template.metadata.labels[HCI_ANNOTATIONS.VM_NAME_PREFIX] = namePrefix;\n\n      const rule = {\n        weight:          1,\n        podAffinityTerm: {\n          topologyKey:   HOSTNAME,\n          labelSelector: { matchLabels: { [HCI_ANNOTATIONS.VM_NAME_PREFIX]: namePrefix } }\n        }\n      };\n\n      return {\n        ...spec,\n        template: {\n          ...spec.template,\n          spec: {\n            ...spec.template.spec,\n            affinity: {\n              ...spec.template.spec.affinity,\n              podAntiAffinity: {\n                ...spec.template.spec?.affinity?.podAntiAffinity,\n                preferredDuringSchedulingIgnoredDuringExecution: [\n                  ...(spec.template.spec?.affinity?.podAntiAffinity?.preferredDuringSchedulingIgnoredDuringExecution || []),\n                  rule\n                ]\n              }\n            }\n          }\n        }\n      };\n    },\n\n    parseNetworkRows(networkRow) {\n      const networks = [];\n      const interfaces = [];\n\n      networkRow.forEach( (R) => {\n        const _network = this.parseNetwork(R);\n        const _interface = this.parseInterface(R);\n\n        networks.push(_network);\n        interfaces.push(_interface);\n      });\n\n      const specInterfaces = this.spec?.template?.spec?.domain?.devices?.interfaces;\n      const mergedInterfaces = this.mergeInterfaceList(specInterfaces, interfaces);\n\n      const spec = {\n        ...this.spec.template.spec,\n        domain: {\n          ...this.spec.template.spec.domain,\n          devices: {\n            ...this.spec.template.spec.domain.devices,\n            interfaces: mergedInterfaces,\n          },\n        },\n        networks\n      };\n\n      this.spec.template['spec'] = spec;\n    },\n\n    parseAccessCredentials() {\n      const out = [];\n      const annotations = {};\n      const users = JSON.parse(this.spec?.template?.metadata?.annotations?.[HCI_ANNOTATIONS.DYNAMIC_SSHKEYS_USERS] || '[]');\n\n      for (const row of this.accessCredentials) {\n        if (this.needNewSecret) {\n          row.secretName = this.generateSecretName(this.secretNamePrefix);\n        }\n\n        if (row.source === ACCESS_CREDENTIALS.RESET_PWD) {\n          users.push(row.username);\n          out.push({\n            userPassword: {\n              source:            { secret: { secretName: row.secretName } },\n              propagationMethod: { qemuGuestAgent: { } }\n            }\n          });\n        }\n\n        if (row.source === ACCESS_CREDENTIALS.INJECT_SSH) {\n          users.push(...row.users);\n          annotations[row.secretName] = row.sshkeys;\n          out.push({\n            sshPublicKey: {\n              source:            { secret: { secretName: row.secretName } },\n              propagationMethod: { qemuGuestAgent: { users: row.users } }\n            }\n          });\n        }\n      }\n\n      if (out.length === 0 && !!this.spec.template.spec.accessCredentials === false) {\n        delete this.spec.template.spec.accessCredentials;\n      } else {\n        this.spec.template.spec.accessCredentials = out;\n      }\n\n      if (users.length !== 0) {\n        this.spec.template.metadata.annotations[HCI_ANNOTATIONS.DYNAMIC_SSHKEYS_USERS] = JSON.stringify(Array.from(new Set(users)));\n        this.spec.template.metadata.annotations[HCI_ANNOTATIONS.DYNAMIC_SSHKEYS_NAMES] = JSON.stringify(annotations);\n      }\n    },\n\n    getMaintenanceStrategyOptionLabel(opt) {\n      return this.t(`harvester.virtualMachine.maintenanceStrategy.options.${ opt.label || opt }`);\n    },\n\n    getInitUserData(config) {\n      const _QGA_JSON = this.getMatchQGA(config.osType);\n\n      const out = jsyaml.dump(_QGA_JSON);\n\n      return `#cloud-config\\n${ out }`;\n    },\n\n    /**\n     * Generate user data yaml which is decided by the\n     * \"Install guest agent\", \"OS type\", \"SSH keys\" and user input.\n     * @param config\n     */\n    getUserData(config) {\n      try {\n        // https://github.com/eemeli/yaml/issues/136\n        let userDataDoc = this.userScript ? YAML.parseDocument(this.userScript) : YAML.parseDocument({});\n\n        const allSSHAuthorizedKeys = this.mergeSSHAuthorizedKeys(this.userScript);\n\n        if (allSSHAuthorizedKeys.length > 0) {\n          userDataDoc.setIn(['ssh_authorized_keys'], allSSHAuthorizedKeys);\n        } else if (YAML.isCollection(userDataDoc.getIn('ssh_authorized_keys'))) {\n          userDataDoc.deleteIn(['ssh_authorized_keys']);\n        }\n\n        userDataDoc = config.installAgent ? this.mergeQGA({ userDataDoc, ...config }) : this.deleteQGA({ userDataDoc, ...config });\n        const userDataYaml = userDataDoc.toString();\n\n        if (userDataYaml === '{}\\n') {\n          // When the YAML parsed value is '{}\\n', it means that the userData is empty, then undefined is returned.\n          return undefined;\n        }\n\n        const hasCloudComment = this.hasCloudConfigComment(userDataYaml);\n\n        return hasCloudComment ? userDataYaml : `#cloud-config\\n${ userDataYaml }`;\n      } catch (e) {\n        console.error('Error: Unable to parse yaml document', e); // eslint-disable-line no-console\n\n        return this.userScript;\n      }\n    },\n\n    updateSSHKey(neu) {\n      this['sshKey'] = neu;\n    },\n\n    updateCpuMemory(cpu, memory, maxCpu = '', maxMemory = null, cpuMemoryHotplugEnabled = false) {\n      this['cpu'] = cpu;\n      this['memory'] = memory;\n      this['maxCpu'] = maxCpu;\n      this['maxMemory'] = maxMemory;\n      this['cpuMemoryHotplugEnabled'] = cpuMemoryHotplugEnabled;\n    },\n\n    parseDataVolumeName(R, prefixName) {\n      let dataVolumeName = '';\n\n      if (R.source === SOURCE_TYPE.ATTACH_VOLUME) {\n        dataVolumeName = R.volumeName;\n      } else if (this.isClone || !this.hasCreateVolumes.includes(R.realName)) {\n        dataVolumeName = `${ prefixName }-${ R.name }-${ randomStr(5).toLowerCase() }`;\n      } else {\n        dataVolumeName = R.realName;\n      }\n\n      return dataVolumeName;\n    },\n\n    parseDisk(R, index) {\n      const out = { name: R.name };\n\n      if (R.type === HARD_DISK) {\n        out.disk = { bus: R.bus };\n      } else if (R.type === CD_ROM) {\n        out.cdrom = { bus: R.bus };\n      }\n\n      out.bootOrder = index + 1;\n\n      return out;\n    },\n\n    parseVolume(R, dataVolumeName) {\n      const out = { name: R.name };\n\n      if (R.source === SOURCE_TYPE.CONTAINER) {\n        out.containerDisk = { image: R.container };\n      } else if (R.source === SOURCE_TYPE.IMAGE || R.source === SOURCE_TYPE.NEW || R.source === SOURCE_TYPE.ATTACH_VOLUME) {\n        out.persistentVolumeClaim = { claimName: dataVolumeName };\n        if (R.hotpluggable) {\n          out.persistentVolumeClaim.hotpluggable = true;\n        }\n      }\n\n      return out;\n    },\n\n    parseVolumeClaimTemplate(R, dataVolumeName) {\n      const sizeString = String(R.size);\n\n      if (!(sizeString.includes('Gi') || sizeString.includes('Ti')) && R.size) {\n        R.size = `${ R.size }${ GIBIBYTE }`;\n      }\n\n      const out = {\n        metadata: { name: dataVolumeName },\n        spec:     {\n          accessModes: [R.accessMode],\n          resources:   { requests: { storage: R.size } },\n          volumeMode:  R.volumeMode\n        }\n      };\n\n      if (R.dataSource) {\n        out.spec.dataSource = R.dataSource;\n      }\n\n      switch (R.source) {\n      case SOURCE_TYPE.ATTACH_VOLUME:\n        out.spec.storageClassName = R.storageClassName;\n        break;\n      case SOURCE_TYPE.NEW:\n        out.spec.storageClassName = R.storageClassName;\n        break;\n      case SOURCE_TYPE.IMAGE: {\n        const image = this.images.find( (I) => R.image === I.id);\n\n        if (image) {\n          out.spec.storageClassName = image.storageClassName;\n          out.metadata.annotations = { [HCI_ANNOTATIONS.IMAGE_ID]: image.id };\n        } else {\n          out.metadata.annotations = { [HCI_ANNOTATIONS.IMAGE_ID]: '' };\n        }\n\n        break;\n      }\n      }\n\n      return out;\n    },\n\n    getSSHListValue(arr) {\n      return arr.map( (id) => this.getSSHValue(id)).filter( (O) => O !== undefined);\n    },\n\n    parseInterface(R) {\n      const _interface = {};\n      const type = R.type;\n\n      _interface[type] = {};\n\n      if (R.macAddress) {\n        _interface.macAddress = R.macAddress;\n      }\n\n      _interface.model = R.model;\n      _interface.name = R.name;\n\n      return _interface;\n    },\n\n    parseNetwork(R) {\n      const out = { name: R.name };\n\n      if (R.isPod) {\n        out.pod = {};\n      } else {\n        out.multus = { networkName: R.networkName };\n      }\n\n      return out;\n    },\n\n    updateUserData(value) {\n      this.userScript = value;\n    },\n\n    updateNetworkData(value) {\n      this.networkScript = value;\n    },\n\n    mergeSSHAuthorizedKeys(yaml) {\n      try {\n        const sshAuthorizedKeys = YAML.parseDocument(yaml)\n          .get('ssh_authorized_keys')\n          ?.toJSON() || [];\n\n        const sshList = this.getSSHListValue(this.sshKey);\n\n        return sshAuthorizedKeys.length ? [...new Set([...sshList, ...sshAuthorizedKeys])] : sshList;\n      } catch (e) {\n        return [];\n      }\n    },\n\n    /**\n     * @param paths A Object path, e.g. 'a.b.c' => ['a', 'b', 'c']. Refer to https://eemeli.org/yaml/#scalar-values\n     * @returns\n     */\n    deleteYamlDocProp(doc, paths) {\n      try {\n        const item = doc.getIn([])?.items[0];\n        const key = item?.key;\n        const hasCloudConfigComment = !!key?.commentBefore?.includes('cloud-config');\n        const isMatchProp = key.source === paths[paths.length - 1];\n\n        if (key && hasCloudConfigComment && isMatchProp) {\n          // Comments are mounted on the next node and we should not delete the node containing cloud-config\n        } else {\n          doc.deleteIn(paths);\n        }\n      } catch (e) {}\n    },\n\n    mergeQGA(config) {\n      const { osType, userDataDoc } = config;\n      const _QGA_JSON = this.getMatchQGA(osType);\n      const userDataYAML = userDataDoc.toString();\n      const userDataJSON = YAML.parse(userDataYAML);\n      let packages = userDataJSON?.packages || [];\n      let runcmd = userDataJSON?.runcmd || [];\n\n      userDataDoc.setIn(['package_update'], true);\n\n      if (Array.isArray(packages)) {\n        if (!packages.includes('qemu-guest-agent')) {\n          packages.push('qemu-guest-agent');\n        }\n      } else {\n        packages = QGA_JSON.packages;\n      }\n\n      if (Array.isArray(runcmd)) {\n        let findIndex = -1;\n        const hasSameRuncmd = runcmd.find( (S) => Array.isArray(S) && S.join('-') === _QGA_JSON.runcmd[0].join('-'));\n\n        const hasSimilarRuncmd = runcmd.find( (S, index) => {\n          if (Array.isArray(S) && S.join('-') === this.getSimilarRuncmd(osType).join('-')) {\n            findIndex = index;\n\n            return true;\n          }\n\n          return false;\n        });\n\n        if (hasSimilarRuncmd) {\n          runcmd[findIndex] = _QGA_JSON.runcmd[0];\n        } else if (!hasSameRuncmd) {\n          runcmd.push(_QGA_JSON.runcmd[0]);\n        }\n      } else {\n        runcmd = _QGA_JSON.runcmd;\n      }\n\n      if (packages.length > 0) {\n        userDataDoc.setIn(['packages'], packages);\n      } else {\n        userDataDoc.setIn(['packages'], []); // It needs to be set empty first, as it is possible that cloud-init comments are mounted on this node\n        this.deleteYamlDocProp(userDataDoc, ['packages']);\n        this.deleteYamlDocProp(userDataDoc, ['package_update']);\n      }\n\n      if (runcmd.length > 0) {\n        userDataDoc.setIn(['runcmd'], runcmd);\n      } else {\n        this.deleteYamlDocProp(userDataDoc, ['runcmd']);\n      }\n\n      return userDataDoc;\n    },\n\n    deleteQGA(config) {\n      const { osType, userDataDoc, deletePackage = false } = config;\n\n      const userDataTemplateValue = this.$store.getters['harvester/byId'](CONFIG_MAP, this.userDataTemplateId)?.data?.cloudInit || '';\n\n      const userDataYAML = userDataDoc.toString();\n      const userDataJSON = YAML.parse(userDataYAML);\n      const packages = userDataJSON?.packages || [];\n      const runcmd = userDataJSON?.runcmd || [];\n\n      if (Array.isArray(packages) && deletePackage) {\n        const templateHasQGAPackage = this.convertToJson(userDataTemplateValue);\n\n        for (let i = 0; i < packages.length; i++) {\n          if (packages[i] === 'qemu-guest-agent') {\n            if (!(Array.isArray(templateHasQGAPackage?.packages) && templateHasQGAPackage.packages.includes('qemu-guest-agent'))) {\n              packages.splice(i, 1);\n            }\n          }\n        }\n      }\n\n      if (Array.isArray(runcmd)) {\n        const _QGA_JSON = this.getMatchQGA(osType);\n\n        for (let i = 0; i < runcmd.length; i++) {\n          if (Array.isArray(runcmd[i]) && runcmd[i].join('-') === _QGA_JSON.runcmd[0].join('-')) {\n            runcmd.splice(i, 1);\n          }\n        }\n      }\n\n      if (packages.length > 0) {\n        userDataDoc.setIn(['packages'], packages);\n      } else {\n        userDataDoc.setIn(['packages'], []);\n        this.deleteYamlDocProp(userDataDoc, ['packages']);\n        this.deleteYamlDocProp(userDataDoc, ['package_update']);\n      }\n\n      if (runcmd.length > 0) {\n        userDataDoc.setIn(['runcmd'], runcmd);\n      } else {\n        this.deleteYamlDocProp(userDataDoc, ['runcmd']);\n      }\n\n      return userDataDoc;\n    },\n\n    generateSecretName(name) {\n      return name ? `${ name }-${ randomStr(5).toLowerCase() }` : undefined;\n    },\n\n    getOwnerReferencesFromVM(resource) {\n      const name = resource.metadata.name;\n      const kind = resource.kind;\n      const apiVersion = this.resourceType === HCI.VM ? 'kubevirt.io/v1' : 'harvesterhci.io/v1beta1';\n      const uid = resource?.metadata?.uid;\n\n      return [{\n        name,\n        kind,\n        uid,\n        apiVersion,\n      }];\n    },\n\n    async saveSecret(vm) {\n      if (!vm?.spec || !this.secretName || this.isWindows) {\n        return true;\n      }\n\n      let secret = this.getSecret(vm.spec);\n\n      if (!secret && this.isEdit && this.secretRef) {\n        // When editing the vm, if the userData and networkData are deleted, we also need to clean up the secret values\n        secret = this.secretRef;\n      }\n\n      if (!secret || this.needNewSecret) {\n        secret = await this.$store.dispatch('harvester/create', {\n          metadata: {\n            name:            this.secretName,\n            namespace:       this.value.metadata.namespace,\n            labels:          { [HCI_ANNOTATIONS.CLOUD_INIT]: 'harvester' },\n            ownerReferences: this.getOwnerReferencesFromVM(vm)\n          },\n          type: SECRET\n        });\n      }\n\n      try {\n        if (secret) {\n          // If none of the data comes from the secret, then no data needs to be saved to the secret\n          if (!this.saveUserDataAsClearText || !this.saveNetworkDataAsClearText) {\n            secret.setData('userdata', this.userData || '');\n            secret.setData('networkdata', this.networkScript || '');\n            await secret.save();\n          }\n        }\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    },\n\n    async saveAccessCredentials(vm) {\n      if (!vm?.spec) {\n        return true;\n      }\n\n      // save\n      const toSave = [];\n\n      for (const row of this.accessCredentials) {\n        let secretRef = row.secretRef;\n\n        if (!secretRef || this.needNewSecret) {\n          secretRef = await this.$store.dispatch('harvester/create', {\n            metadata: {\n              name:            row.secretName,\n              namespace:       vm.metadata.namespace,\n              labels:          { [HCI_ANNOTATIONS.CLOUD_INIT]: 'harvester' },\n              ownerReferences: this.getOwnerReferencesFromVM(vm)\n            },\n            type: SECRET\n          });\n        }\n\n        if (row.source === ACCESS_CREDENTIALS.RESET_PWD) {\n          secretRef.setData(row.username, row.newPassword);\n        }\n\n        if (row.source === ACCESS_CREDENTIALS.INJECT_SSH) {\n          for (const secretId of row.sshkeys) {\n            const keypair = (this.$store.getters['harvester/all'](HCI.SSH) || []).find((s) => s.id === secretId);\n\n            secretRef.setData(`${ keypair.metadata.namespace }-${ keypair.metadata.name }`, keypair.spec.publicKey);\n          }\n        }\n\n        toSave.push(secretRef);\n      }\n\n      try {\n        for (const resource of toSave) {\n          await resource.save();\n        }\n      } catch (e) {\n        return Promise.reject(e);\n      }\n    },\n\n    getAccessCredentialsValidation() {\n      const errors = [];\n\n      for (let i = 0; i < this.accessCredentials.length; i++) {\n        const row = this.accessCredentials[i];\n        const source = row.source;\n\n        if (source === ACCESS_CREDENTIALS.RESET_PWD) {\n          if (!row.username) {\n            const fieldName = this.t('harvester.virtualMachine.input.username');\n            const message = this.t('validation.required', { key: fieldName });\n\n            errors.push(message);\n          }\n\n          if (!row.newPassword) {\n            const fieldName = this.t('harvester.virtualMachine.input.password');\n            const message = this.t('validation.required', { key: fieldName });\n\n            errors.push(message);\n          }\n\n          if (row.newPassword && row.newPassword.length < 6) {\n            const fieldName = this.t('harvester.virtualMachine.input.password');\n            const message = this.t('validation.number.min', { key: fieldName, val: '6' });\n\n            errors.push(message);\n          }\n        } else {\n          if (!row.users || row.users.length === 0) {\n            const fieldName = this.t('harvester.virtualMachine.input.username');\n            const message = this.t('validation.required', { key: fieldName });\n\n            errors.push(message);\n          }\n\n          if (!row.sshkeys || row.sshkeys.length === 0) {\n            const fieldName = this.t('harvester.virtualMachine.input.sshKeyValue');\n            const message = this.t('validation.required', { key: fieldName });\n\n            errors.push(message);\n          }\n        }\n\n        if (errors.length > 0) {\n          break;\n        }\n      }\n\n      return errors;\n    },\n\n    getHasCreatedVolumes(spec) {\n      const out = [];\n\n      if (spec.template.spec.volumes) {\n        spec.template.spec.volumes.forEach((V) => {\n          if (V?.persistentVolumeClaim?.claimName) {\n            out.push(V.persistentVolumeClaim.claimName);\n          }\n        });\n      }\n\n      return out;\n    },\n\n    handlerUSBTablet(val) {\n      const hasExist = this.isInstallUSBTablet(this.spec);\n      const inputs = this.spec.template.spec.domain.devices?.inputs || [];\n\n      if (val && !hasExist) {\n        if (inputs.length > 0) {\n          inputs.push(USB_TABLET[0]);\n        } else {\n          Object.assign(this.spec.template.spec.domain.devices, {\n            inputs: [\n              USB_TABLET[0]\n            ]\n          });\n        }\n      } else if (!val) {\n        const index = inputs.findIndex((O) => isEqual(O, USB_TABLET[0]));\n\n        if (hasExist && inputs.length === 1) {\n          delete this.spec.template.spec.domain.devices['inputs'];\n        } else if (hasExist) {\n          inputs.splice(index, 1);\n          this.spec.template.spec.domain.devices['inputs'] = inputs;\n        }\n      }\n    },\n\n    setBootMethod(boot = {\n      efi: false, secureBoot: false, efiPersistentStateEnabled: false\n    }) {\n      if (boot.efi) {\n        set(this.spec.template.spec.domain, 'firmware.bootloader.efi.secureBoot', boot.secureBoot);\n      } else {\n        delete this.spec.template.spec.domain['firmware'];\n        delete this.spec.template.spec.domain.features['smm'];\n\n        return;\n      }\n\n      if (boot.secureBoot) {\n        set(this.spec.template.spec.domain, 'features.smm.enabled', true);\n      } else {\n        try {\n          delete this.spec.template.spec.domain.features.smm['enabled'];\n          const noKeys = Object.keys(this.spec.template.spec.domain.features.smm).length === 0;\n\n          if (noKeys) {\n            delete this.spec.template.spec.domain.features['smm'];\n          }\n        } catch (e) {}\n      }\n\n      if (boot.efiPersistentStateEnabled) {\n        set(this.spec.template.spec.domain, 'firmware.bootloader.efi.persistent', true);\n      } else {\n        delete this.spec.template.spec.domain.firmware.bootloader.efi['persistent'];\n      }\n    },\n\n    setCpuPinning(value) {\n      if (value) {\n        set(this.spec.template.spec.domain.cpu, 'dedicatedCpuPlacement', true);\n      } else {\n        delete this.spec.template.spec.domain.cpu['dedicatedCpuPlacement'];\n      }\n    },\n\n    setTPM({ tpmEnabled = false, tpmPersistentStateEnabled = false } = {}) {\n      if (tpmEnabled) {\n        set(this.spec.template.spec.domain.devices, 'tpm', tpmPersistentStateEnabled ? { persistent: true } : {});\n      } else {\n        delete this.spec.template.spec.domain.devices['tpm'];\n      }\n    },\n\n    deleteSSHFromUserData(ssh = []) {\n      const sshAuthorizedKeys = this.getSSHFromUserData(this.userScript);\n\n      ssh.map((id) => {\n        const index = sshAuthorizedKeys.findIndex((value) => value === this.getSSHValue(id));\n\n        if (index >= 0) {\n          sshAuthorizedKeys.splice(index, 1);\n        }\n      });\n      const userDataJson = this.convertToJson(this.userScript);\n\n      userDataJson.ssh_authorized_keys = sshAuthorizedKeys;\n\n      if (sshAuthorizedKeys.length === 0) {\n        delete userDataJson.ssh_authorized_keys;\n      }\n\n      if (isEmpty(userDataJson)) {\n        this['userScript'] = undefined;\n      } else {\n        this['userScript'] = jsyaml.dump(userDataJson);\n      }\n\n      this.refreshYamlEditor();\n    },\n\n    mergeInterfaceList(specInterfaceList, interfaceList) {\n      if (!specInterfaceList || specInterfaceList.length === 0) {\n        return interfaceList;\n      }\n      const specInterfaceMap = new Map(specInterfaceList.map((iface) => [iface.name, iface]));\n\n      return interfaceList.map((iface) => {\n        const specInterface = specInterfaceMap.get(iface.name);\n\n        if (specInterface) {\n          const merged = { ...specInterface, ...iface };\n\n          // currently we only have bridge and masquerade network type, they are mutually exclusive\n          if (iface['bridge']) {\n            delete merged['masquerade'];\n          } else {\n            delete merged['bridge'];\n          }\n\n          return merged;\n        }\n\n        return iface;\n      });\n    },\n\n    mergeDeviceList(specDeviceList, deviceList) {\n      if (!specDeviceList || specDeviceList.length === 0) {\n        return deviceList;\n      }\n      const specDeviceMap = new Map(specDeviceList.map((device) => [device.name, device]));\n\n      return deviceList.map((device) => {\n        const specDevice = specDeviceMap.get(device.name);\n\n        if (specDevice) {\n          return { ...specDevice, ...device };\n        }\n\n        return device;\n      });\n    },\n\n    refreshYamlEditor() {\n      this.$nextTick(() => {\n        this.$refs.yamlEditor?.updateValue();\n      });\n    },\n\n    toggleAdvanced() {\n      this.showAdvanced = !this.showAdvanced;\n    },\n\n    updateAgent(value) {\n      if (!value) {\n        this.deletePackage = true;\n      }\n    },\n\n    updateDataTemplateId(type, id) {\n      if (type === 'user') {\n        const oldInstallAgent = this.installAgent;\n\n        this.userDataTemplateId = id;\n        this.$nextTick(() => {\n          if (oldInstallAgent) {\n            this.installAgent = oldInstallAgent;\n          }\n        });\n      }\n    },\n\n    updateReserved(value = {}) {\n      const { memory } = value;\n\n      this['reservedMemory'] = memory;\n    },\n\n    updateTerminationGracePeriodSeconds(value) {\n      this['terminationGracePeriodSeconds'] = value;\n    },\n  },\n\n  watch: {\n    diskRows: {\n      handler(neu, old) {\n        if (Array.isArray(neu)) {\n          const imageId = neu[0]?.image;\n          const image = this.images.find( (I) => imageId === I.id);\n          const osType = image?.imageOSType;\n\n          const oldImageId = old[0]?.image;\n\n          if (this.isCreate && oldImageId === imageId && imageId) {\n            this.osType = osType;\n          }\n        }\n      }\n    },\n\n    secretRef: {\n      handler(secret) {\n        // we should not inherit the secret if it's from VM template.\n        if (secret && this.resourceType !== HCI.BACKUP && !this.useTemplate) {\n          this.secretName = secret?.metadata.name;\n        }\n      },\n      immediate: true,\n      deep:      true\n    },\n\n    isWindows(val) {\n      if (val) {\n        this['sshKey'] = [];\n        this['userScript'] = undefined;\n        this['networkScript'] = undefined;\n        this['installAgent'] = false;\n      }\n    },\n\n    installUSBTablet(val) {\n      this.handlerUSBTablet(val);\n    },\n\n    efiEnabled(val) {\n      this.setBootMethod({\n        efi: val, secureBoot: this.secureBoot, efiPersistentStateEnabled: this.efiPersistentStateEnabled\n      });\n    },\n\n    secureBoot(val) {\n      this.setBootMethod({\n        efi: this.efiEnabled, secureBoot: val, efiPersistentStateEnabled: this.efiPersistentStateEnabled\n      });\n    },\n\n    efiPersistentStateEnabled(val) {\n      this.setBootMethod({\n        efi: this.efiEnabled, secureBoot: this.secureBoot, efiPersistentStateEnabled: val\n      });\n    },\n\n    cpuPinning(value) {\n      this.setCpuPinning(value);\n    },\n\n    tpmEnabled(val) {\n      this.setTPM({ tpmEnabled: val, tpmPersistentStateEnabled: this.tpmPersistentStateEnabled });\n    },\n\n    tpmPersistentStateEnabled(val) {\n      this.setTPM({ tpmEnabled: this.tpmEnabled, tpmPersistentStateEnabled: val });\n    },\n\n    installAgent: {\n      /**\n       * rules\n       * 1. The value in user Data is the first priority\n       * 2. After selecting the template, if checkbox is checked, only merge operation will be performed on user data,\n       *    if checkbox is unchecked, no value will be deleted in user data\n       */\n      handler(neu) {\n        if (this.deleteAgent) {\n          this['userScript'] = this.getUserData({\n            installAgent: neu, osType: this.osType, deletePackage: this.deletePackage\n          });\n          this.refreshYamlEditor();\n        }\n        this.deleteAgent = true;\n        this.deletePackage = false;\n      }\n    },\n\n    osType(neu, old) {\n      this.installAgent = old === 'windows' ? true : this.installAgent;\n      const out = old === 'windows' ? this.getInitUserData({ osType: neu }) : this.getUserData({ installAgent: this.installAgent, osType: neu });\n\n      this['userScript'] = out;\n      this.refreshYamlEditor();\n    },\n\n    userScript(neu, old) {\n      const hasInstallAgent = this.hasInstallAgent(neu, this.osType, this.installAgent);\n\n      if (hasInstallAgent !== this.installAgent) {\n        this.deleteAgent = false;\n        this.installAgent = hasInstallAgent;\n      }\n    },\n\n    sshKey(neu, old) {\n      const _diff = difference(old, neu);\n\n      // delete removed ssh key in userdata if needed\n      if (_diff.length > 0 && this.isCreate) {\n        this.deleteSSHFromUserData(_diff);\n      }\n\n      // refresh yaml editor to get the latest userScript\n      this.userScript = this.getUserData({ installAgent: this.installAgent, osType: this.osType });\n      this.refreshYamlEditor();\n    }\n  }\n};\n"],"names":["QGA_JSON","package_update","packages","runcmd","QGA_MAP","default","USB_TABLET","bus","name","type","SSH_EXISTING_TYPE","EXISTING_ALL","EXISTING_ONLY_ANNOTATION","EXISTING_ONLY_CLOUD","methods","hasCloudConfigComment","userScript","userDataDoc","YAML","items","contents","exist","comment","includes","commentBefore","map","item","key","getSSHValue","id","inStore","this","$store","getters","sshs","HCI","SSH","find","O","spec","publicKey","undefined","getOsType","vm","metadata","labels","HCI_ANNOTATIONS","OS","getMatchQGA","osType","_QGA_JSON","clone","hasCustomQGA","forEach","match","getSimilarRuncmd","hasInstallAgent","oldValue","dataFormat","jsyaml","e","Error","S","Array","isArray","join","isInstallUSBTablet","inputs","template","domain","devices","isEqual","isEfiEnabled","firmware","bootloader","efi","isTpmEnabled","tpm","isTPMPersistentStateEnabled","persistent","isEFIPersistentStateEnabled","isSecureBoot","secureBoot","isCpuPinning","cpu","dedicatedCpuPlacement","getCloudInitNoCloud","secret","getSecret","userData","decodedData","userdata","networkData","networkdata","cloudInitNoCloud","volumes","V","saveUserDataAsClearText","saveNetworkDataAsClearText","secrets","SECRET","secretName","secretRef","networkDataSecretRef","s","getAccessCredentials","credentials","accessCredentials","annotations","JSON","parse","DYNAMIC_SSHKEYS_NAMES","c","source","userPassword","out","username","newPassword","users","sshkeys","Object","keys","data","propagationMethod","qemuGuestAgent","getRootImageId","parseVolumeClaimTemplates","IMAGE_ID","getSSHFromAnnotation","ids","SSH_NAMES","convertToJson","script","getSSHFromUserData","ssh_authorized_keys","compareSSHValue","a","b","r","replace","mergeAllSSHs","length","allSSHs","hasSSHResource","ssh","_userDataSSH","sshValue","push","LONGHORN_V2_DATA_ENGINE","MANAGEMENT_NETWORK","label","value","CD_ROM","HARD_DISK","mixins","impl","props","required","resourceType","String","fetch","hash","pvs","dispatch","PV","pvcs","PVC","storageClasses","STORAGE_CLASS","settings","SETTING","images","IMAGE","versions","VM_VERSION","templates","VM_TEMPLATE","networkAttachment","NETWORK_ATTACHMENT","vmis","VMI","vmims","VMIM","vms","VM","addons","ADD_ONS","longhornV2Engine","LONGHORN","SETTINGS","NODE","nodes","CLUSTER_NETWORK","clusterNetworks","VLAN_CONFIG","VOLUMES","longhornVolumes","res","allHash","hasPCISchema","PCI_DEVICE","hasSRIOVGPUSchema","SR_IOVGPU_DEVICE","enabledAddons","reduce","acc","addon","enabled","enabledPCI","PCI_DEVICE_CONTROLLER","enabledSriovgpu","NVIDIA_DRIVER_TOOLKIT_CONTROLLER","isClone","realMode","_CLONE","showYaml","useTemplate","sshKey","maintenanceStrategies","maintenanceStrategy","runStrategies","runStrategy","installAgent","hasCreateVolumes","installUSBTablet","networkScript","imageId","diskRows","networkRows","machineType","machineTypes","showAdvanced","deleteAgent","memory","maxMemory","maxCpu","cpuMemoryHotplugEnabled","reservedMemory","efiEnabled","tpmEnabled","tpmPersistentStateEnabled","efiPersistentStateEnabled","userDataTemplateId","immutableMode","_CREATE","_VIEW","terminationGracePeriodSeconds","cpuPinning","cpuModel","computed","filteredNamespaces","NAMESPACE","filter","namespace","isSystem","nodesIdOptions","networkNames","n","networkName","vmNetworks","selectedVMNetworks","uniq","clusterNetworkResource","N","isUnSchedulable","isEtcd","node","requireLabelKeys","isNetworkSchedule","clusterNetwork","requireLabelKey","nameDisplay","t","disabled","storageClassSetting","storageClassValue","HCI_SETTING","DEFAULT_STORAGE_CLASS","customVolumeMode","volumeMode","VOLUME_MODE","BLOCK","customAccessMode","accessModes","isWindows","needNewSecret","isCreate","defaultTerminationSetting","setting","VM_TERMINATION_PERIOD","Number","affinityLabels","namespaceInputLabel","namespaceSelectionLabels","addLabel","topologyKeyPlaceholder","created","vmMachineTypeAutoFeatureEnabled","url","err","getInitConfig","init","config","existUserData","fromTemplate","BACKUP","status","volumeBackups","resources","limits","requests","VM_MAINTENANCE_MODE_STRATEGY","machine","isHotplugEnabled","getVmCPUMemoryValues","VM_RESERVED_MEMORY","getDiskRows","getNetworkRows","getHasCreatedVolumes","secretBackups","secretNetworkData","secretUserData","base64Decode","getInitUserData","model","prototype","hasOwnProperty","call","running","refreshYamlEditor","volBackups","_volumes","_disks","disks","_volumeClaimTemplates","size","imageResource","I","isIsoImage","test","imageSuffix","imageSize","Math","max","virtualSize","isEncrypted","vBackup","volumeName","imageSizeGiB","ceil","GIBIBYTE","randomStr","SOURCE_TYPE","accessMode","storageClassName","image","DISK","index","volume","realName","container","hotpluggable","dataSource","cdrom","disk","EMPTY_IMAGE","containerDisk","CONTAINER","persistentVolumeClaim","claimName","DVT","T","NEW","dataVolumeSpecPVC","storage","allPVCs","pvcResource","ATTACH_VOLUME","bootOrder","parseValue","parseSi","formatSize","formatSi","increment","addSuffix","maxExponent","minExponent","pvc","P","volumeStatus","relatedPV","VOLUME_ERROR","sortBy","networks","interfaces","network","sriov","bridge","isPod","pod","newCreateId","multus","parseVM","getUserData","parseOther","parseAccessCredentials","parseNetworkRows","parseDiskRows","setCPUAndMemory","VM_CPU_MEMORY_HOTPLUG","toString","sockets","cores","set","maxGuest","needVolume","R","diskNameLabels","volumeClaimTemplates","_disk","parseDisk","prefixName","dataVolumeName","parseDataVolumeName","_volume","parseVolume","_dataVolumeTemplate","parseVolumeClaimTemplate","generateSecretName","secretNamePrefix","D","cloudinitdisk","specDisks","mergedDisks","mergeDeviceList","stringify","VM_NAME","isSingle","multiVMScheduler","VOLUME_CLAIM_TEMPLATE","NETWORK_IPS","networkIps","CREATOR","removeTrailingHyphen","str","endsWith","slice","namePrefix","VM_NAME_PREFIX","rule","weight","podAffinityTerm","topologyKey","HOSTNAME","labelSelector","matchLabels","affinity","podAntiAffinity","preferredDuringSchedulingIgnoredDuringExecution","networkRow","_network","parseNetwork","_interface","parseInterface","specInterfaces","mergedInterfaces","mergeInterfaceList","DYNAMIC_SSHKEYS_USERS","row","ACCESS_CREDENTIALS","RESET_PWD","INJECT_SSH","sshPublicKey","from","Set","getMaintenanceStrategyOptionLabel","opt","allSSHAuthorizedKeys","mergeSSHAuthorizedKeys","setIn","getIn","deleteIn","mergeQGA","deleteQGA","userDataYaml","hasCloudComment","console","error","updateSSHKey","neu","updateCpuMemory","toLowerCase","sizeString","getSSHListValue","arr","macAddress","updateUserData","updateNetworkData","yaml","sshAuthorizedKeys","get","toJSON","sshList","deleteYamlDocProp","doc","paths","isMatchProp","userDataYAML","userDataJSON","findIndex","hasSameRuncmd","hasSimilarRuncmd","deletePackage","userDataTemplateValue","CONFIG_MAP","cloudInit","templateHasQGAPackage","i","splice","getOwnerReferencesFromVM","resource","kind","apiVersion","uid","saveSecret","isEdit","CLOUD_INIT","ownerReferences","setData","save","Promise","reject","saveAccessCredentials","toSave","secretId","keypair","getAccessCredentialsValidation","errors","fieldName","message","val","handlerUSBTablet","hasExist","assign","setBootMethod","boot","features","smm","noKeys","setCpuPinning","setTPM","deleteSSHFromUserData","userDataJson","isEmpty","specInterfaceList","interfaceList","specInterfaceMap","Map","iface","specInterface","merged","specDeviceList","deviceList","specDeviceMap","device","specDevice","$nextTick","$refs","yamlEditor","updateValue","toggleAdvanced","updateAgent","updateDataTemplateId","oldInstallAgent","updateReserved","updateTerminationGracePeriodSeconds","watch","handler","old","imageOSType","oldImageId","immediate","deep","_diff","difference"],"sourceRoot":""}